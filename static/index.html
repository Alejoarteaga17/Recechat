<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Recechat</title>
        <style>
    :root{--bg:#f7f8fb;--card:#fff;--muted:#6b7280;--accent:#5d88f0}

    body { font-family: Inter, system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; background:var(--bg); margin:0; padding:24px; }
    .app { max-width: 1000px; margin: 0 auto; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
    h1 { font-size:22px; margin:0; }

    .controls { display:flex; gap:8px; align-items:center; margin-bottom:16px; }
    input[type=text], input[type=number] { padding:8px 10px; border-radius:8px; border:1px solid #e6e9ef; }

    /* âœ… Botones globales ahora claritos */
button {
    background:#eef2ff;
    color:#3b4fc4;
    border:2px solid var(--accent);
    padding:10px 18px;
    border-radius:18px;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    transition:0.2s;
    box-shadow:0 3px 8px rgba(93,136,240,0.18);
}
button:hover {
    background:#dce3ff;
    transform:translateY(-2px);
}
button:active {
    transform:scale(0.96);
}

    /* ğŸ”¹ Botones secundarios (No, Back...) */
    button.btn-secondary {
        background:#d1d5db;
        color:#111;
        box-shadow:0 3px 6px rgba(0,0,0,0.12);
    }
    button.btn-secondary:hover { background:#c2c5c9; }

    /* ğŸ”¹ Botones numÃ©ricos de selecciÃ³n */
    button.btn-pick {
        background:#eef2ff;
        color:#3b4fc4;
        border:2px solid #5d88f0;
    }
    button.btn-pick:hover {
        background:#dce3ff;
    }

    /* ğŸ”¹ Botones dentro de burbujas */
    .message.assistant button {
        font-size:13px;
        padding:8px 14px;
        border-radius:14px;
    }

    /* â“Botones de feedback */
    .like-btn, .dislike-btn {
        background:#fff !important;
        color:#444;
        border:1px solid #c6c6c6;
        box-shadow:none;
    }
    .like-btn:hover { background:#d9f7db !important; border-color:#4ade80; }
    .dislike-btn:hover { background:#ffe0e0 !important; border-color:#f43f5e; }

    /* ğŸ”„ More button */
    .more-btn {
        background:#eef2ff;
        color:#3b4fc4;
    }
    .more-btn:hover {
        background:#dce3ff;
    }

    .results { margin-top:12px; }
    .card { background:var(--card); border-radius:10px; padding:14px; margin-bottom:12px; box-shadow:0 8px 22px rgba(16,24,40,0.06); }

    .title { font-weight:700; font-size:16px; color:#0f1724;}
    .meta { color:var(--muted); font-size:13px; margin-top:6px;}
    .ingredients { margin-top:8px; color:#374151; font-size:14px; }
    details summary { cursor:pointer; font-weight:600; margin-top:8px; }
    details div { margin-top:8px; color:#374151; }

    .feedback { margin-top:10px; display:flex; gap:8px; }
    .feedback button { padding:6px 10px; }

    .small { font-size:13px; color:var(--muted); }

    /* ğŸ’¬ Chat bubbles */
    .message { margin:8px 0; display:flex; align-items:flex-end; gap:8px; }
    .message.assistant { justify-content:flex-start; }
    .message.user { justify-content:flex-end; }
    
    .bubble { max-width:82%; padding:10px 14px; border-radius:12px; }

    .user-bubble { 
        background:#e8edf7; 
        padding:12px 16px; 
        border-radius:18px 18px 0 18px; 
    }
    .assistant-bubble { 
        background:#5d88f0; 
        padding:12px 16px; 
        border-radius:18px 18px 18px 0; 
        color:#fff;
        line-height:1.4; 
    }

    .avatar { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:14px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .user .avatar { background:#94a3b8; }
    .assistant .avatar { background:#5d88f0; }

    .msg-content { display:flex; flex-direction:column; gap:4px; }
    .timestamp { color:var(--muted); font-size:12px; }
    .message.user .timestamp { text-align:left; }
    .message.assistant .timestamp { text-align:right; }
</style>

    </head>
    <body>
        <div class="app">
            <header>
            <h1>Recechat - Recipes Recommender</h1>
            <div class="small">API: <code>/api/chat/start</code></div>
            </header>
                        <div id="status" class="small">Write a message below and hit send.</div>

                        <div id="chat" style="margin-top:12px; border-radius:8px; background:#fff; padding:12px; min-height:420px; max-height:64vh; overflow:auto; box-shadow:0 6px 18px rgba(16,24,40,0.04);">
                        <!-- messages will be appended here -->
                        </div>

                        <!-- Unified chat input -->
                        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
                            <input id="chat-input" type="text" placeholder="Write a message..." style="flex:1; padding:10px 12px; border-radius:999px; border:1px solid #e6e9ef;" />
                            <button id="send" style="padding:10px 14px; border-radius:999px;">Send</button>
                        </div>
        </div>

        <script>
            // small state for chat
            let currentSessionId = null;
            let lastQuery = '';
            // Action prompt state: when assistant asks "Did you like any recipe?"
            let expectingAction = false;
            let actionOffset = 0;
            let actionTotal = 0;
            let actionSessionId = null;
            // Detail prompt state: when assistant shows options after selecting a recipe (1 see / 2 back)
            let expectingDetailAction = false;
            let detailSelectedIdx = null;

                        function escapeHtml(unsafe) {
            if(!unsafe) return '';
            return unsafe.replace(/[&<"'>]/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"})[m]; });
            }

                        function nowHM(){
                            try{
                                return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                            }catch(_){ return new Date().toLocaleTimeString(); }
                        }

            document.getElementById('send').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChatMessage(); });

            function normalizeActionToken(tok){
                if(!tok) return tok;
                tok = String(tok).trim().toLowerCase();
                const map = {
                    'y':'yes','yes':'yes','si':'yes','s':'yes',
                    'n':'no','no':'no',
                    'm':'more','more':'more',
                    'q':'exit','quit':'exit','exit':'exit',
                    'see':'1','instructions':'1','1':'1',
                    'back':'2','2':'2'
                };
                return map[tok] || tok;
            }

            function interpretUserInput(text){
                if(!text) return {action:null, index:null};
                const t = String(text).trim().toLowerCase();
                // pure number => selection
                if(/^\d+$/.test(t)) return {action:'select', index: parseInt(t,10)-1};
                const parts = t.split(/\s+|,|\.|!|\?|\(|\)/).map(p=>normalizeActionToken(p)).filter(Boolean);
                for(const p of parts){
                    if(['yes','no','more','exit'].includes(p)) return {action:p, index:null};
                    if(p==='1') return {action:'detail1', index:null};
                    if(p==='2') return {action:'detail2', index:null};
                }
                // fuzzy contains
                if(t.includes('more')) return {action:'more', index:null};
                if(['yes','y','si'].includes(t)) return {action:'yes', index:null};
                if(['no','n'].includes(t)) return {action:'no', index:null};
                if(['exit','quit','q'].includes(t)) return {action:'exit', index:null};
                return {action:null, index:null};
            }

            async function sendChatMessage(){
                const inp = document.getElementById('chat-input');
                const text = inp.value.trim();
                if(!text) return;
                inp.value = '';
                appendUserMessage(text);
                lastQuery = text;
                scrollChatToBottom();

                // If assistant currently expects an action (yes/no/more/exit/number), interpret typed text
                if(expectingDetailAction){
                    // Prefer explicit numeric 1/2 for detail actions (show instructions / back)
                    const ttrim = String(text).trim();
                    if(/^\s*1\s*$/.test(ttrim) || /see|instruction|instructions/i.test(ttrim)){
                        const idx = (Number.isInteger(parseInt(ttrim)) ? detailSelectedIdx : detailSelectedIdx);
                        expectingDetailAction = false;
                        detailSelectedIdx = null;
                        try{
                            const r = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: idx})});
                            const d = await r.json();
                            if(d.error){ appendAssistantMessage('Error: '+d.error); }
                            else{
                                const steps = String(d.instructions||'').split(/\n+|\r+|\.(?=\s|$)/).map(s=>s.trim()).filter(Boolean);
                                let itxt = 'ğŸ‘¨â€ğŸ³ Instructions:\n\n';
                                steps.forEach((s,i)=>{ itxt += `${i+1}. ${s}\n`; });
                                appendAssistantMessage(itxt);
                            }
                        }catch(err){ appendAssistantMessage('Error: '+err); }
                        scrollChatToBottom();
                        return;
                    }

                    if(/^\s*2\s*$/.test(ttrim) || /back/i.test(ttrim)){
                        // back to recipe list
                        expectingDetailAction = false;
                        const off = actionOffset || 0; const tot = actionTotal || 0;
                        showActionPrompt(off, tot);
                        scrollChatToBottom();
                        return;
                    }
                    // not recognized -> fallthrough and treat as normal chat start
                }

                if(expectingAction){
                    const parsed = interpretUserInput(text);
                    // selection by number relative to current page
                    if(parsed.action === 'select' && parsed.index!=null){
                        const globalIdx = actionOffset + parsed.index;
                        expectingAction = false;
                        try{
                            const resp = await fetch('/api/chat/recipe_ingredients', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: actionSessionId, index: globalIdx, available: lastQuery})});
                            const data = await resp.json();
                            if(data.error){ appendAssistantMessage('Error: '+data.error); }
                            else{
                                let txt = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                                txt += `ğŸ½ï¸ Recipe: ${data.title}\n`;
                                txt += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
                                txt += `Ingredients:\n\n`;
                                for(const ing of data.ingredients){ txt += `â€¢ ${ing.text}\n`; }
                                appendAssistantMessage(txt);

                                // show detail options (1 see / 2 back)
                                const w2 = document.createElement('div');
                                w2.className = 'message assistant';
                                const b2 = document.createElement('div');
                                b2.className = 'bubble assistant-bubble';
                                b2.innerHTML = `\n                                            <div>What would you like to do?</div>\n                                            <div style="margin-top:8px; display:flex; gap:8px;">\n                                                <button class="btn-see-inst">1ï¸ See instructions</button>\n                                                <button class="btn-back-list">2ï¸ Back to recipe list</button>\n                                            </div>\n                                        `;
                                w2.appendChild(b2);
                                const chat = document.getElementById('chat'); chat.appendChild(w2);

                                // set detail expectation so typed '1'/'2' work
                                expectingDetailAction = true;
                                detailSelectedIdx = globalIdx;

                                b2.querySelector('.btn-see-inst').addEventListener('click', async ()=>{
                                    appendUserMessage('1');
                                    expectingDetailAction = false;
                                    try{
                                        const r = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: globalIdx})});
                                        const d = await r.json();
                                        if(d.error){ appendAssistantMessage('Error: '+d.error); }
                                        else{
                                            const steps = String(d.instructions||'').split(/\n+|\r+|\.(?=\s|$)/).map(s=>s.trim()).filter(Boolean);
                                            let itxt = 'ğŸ‘¨â€ğŸ³ Instructions:\n\n';
                                            steps.forEach((s,i)=>{ itxt += `${i+1}. ${s}\n`; });
                                            appendAssistantMessage(itxt);
                                        }
                                        scrollChatToBottom();
                                    }catch(err){ appendAssistantMessage('Error: '+err); }
                                });

                                b2.querySelector('.btn-back-list').addEventListener('click', ()=>{
                                    appendUserMessage('2');
                                    expectingDetailAction = false;
                                    showActionPrompt(actionOffset, actionTotal);
                                    scrollChatToBottom();
                                });
                            }
                        }catch(err){ appendAssistantMessage('Error: '+err); }
                        scrollChatToBottom();
                        return;
                    }

                    if(parsed.action === 'yes'){
                        // emulate clicking Yes button: ask which number
                        expectingAction = false;
                        // create pick UI exactly like the Yes button handler
                        const count = Math.min(3, Math.max(0, actionTotal - actionOffset));
                        const b = document.createElement('div');
                        b.className = 'bubble assistant-bubble';
                        let html = '<div>Which number did you like?</div><div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">';
                        for(let i=1;i<=count;i++){ html += `<button class="btn-pick" data-index="${actionOffset + (i-1)}">${i}</button>`; }
                        html += '</div>';
                        b.innerHTML = html;
                        appendAssistantNode(b);
                        b.querySelectorAll('.btn-pick').forEach(btn=>{
                            btn.addEventListener('click', async ()=>{
                                const globalIdx = parseInt(btn.getAttribute('data-index'));
                                appendUserMessage(String(globalIdx+1));
                                expectingAction = false;
                                try{
                                    const resp = await fetch('/api/chat/recipe_ingredients', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: actionSessionId, index: globalIdx, available: lastQuery})});
                                    const data = await resp.json();
                                    if(data.error){ appendAssistantMessage('Error: '+data.error); }
                                    else{
                                        let txt = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                                        txt += `ğŸ½ï¸ Recipe: ${data.title}\n`;
                                        txt += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
                                        txt += `Ingredients:\n\n`;
                                        for(const ing of data.ingredients){ txt += `â€¢ ${ing.text}\n`; }
                                        appendAssistantMessage(txt);

                                        // detail options
                                        const w2 = document.createElement('div');
                                        w2.className = 'message assistant';
                                        const b2 = document.createElement('div');
                                        b2.className = 'bubble assistant-bubble';
                                        b2.innerHTML = `\n                                                <div>What would you like to do?</div>\n                                                <div style="margin-top:8px; display:flex; gap:8px;">\n                                                    <button class="btn-see-inst">1ï¸ See instructions</button>\n                                                    <button class="btn-back-list">2ï¸ Back to recipe list</button>\n                                                </div>\n                                            `;
                                        w2.appendChild(b2); chat.appendChild(w2);

                                        expectingDetailAction = true;
                                        detailSelectedIdx = globalIdx;

                                        b2.querySelector('.btn-see-inst').addEventListener('click', async ()=>{
                                            appendUserMessage('1');
                                            expectingDetailAction = false;
                                            try{
                                                const r = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: globalIdx})});
                                                const d = await r.json();
                                                if(d.error){ appendAssistantMessage('Error: '+d.error); }
                                                else{
                                                    const steps = String(d.instructions||'').split(/\n+|\r+|\.(?=\s|$)/).map(s=>s.trim()).filter(Boolean);
                                                    let itxt = 'ğŸ‘¨â€ğŸ³ Instructions:\n\n';
                                                    steps.forEach((s,i)=>{ itxt += `${i+1}. ${s}\n`; });
                                                    appendAssistantMessage(itxt);
                                                }
                                            }catch(err){ appendAssistantMessage('Error: '+err); }
                                        });

                                        b2.querySelector('.btn-back-list').addEventListener('click', ()=>{
                                            appendUserMessage('2');
                                            expectingDetailAction = false;
                                            showActionPrompt(actionOffset, actionTotal);
                                            scrollChatToBottom();
                                        });
                                    }
                                }catch(err){ appendAssistantMessage('Error: '+err); }
                                scrollChatToBottom();
                            });
                        });
                        scrollChatToBottom();
                        return;
                    }

                    if(parsed.action === 'no'){
                        appendAssistantMessage("I'll keep improving!");
                        expectingAction = false;
                        scrollChatToBottom();
                        return;
                    }

                    if(parsed.action === 'more'){
                        // forward to /api/chat/more
                        expectingAction = false;
                        try{
                            const resp = await fetch('/api/chat/more', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: actionSessionId})});
                            const data = await resp.json();
                            if(data.error){ appendAssistantMessage('Error: '+data.error); }
                            else{
                                if(data.text) appendAssistantMessage(data.text);
                                // show prompt again referencing new offset
                                showActionPrompt(data.offset, actionTotal);
                            }
                        }catch(err){ appendAssistantMessage('Error: '+err); }
                        scrollChatToBottom();
                        return;
                    }

                    if(parsed.action === 'exit'){
                        appendAssistantMessage('Goodbye ğŸ‘‹');
                        expectingAction = false;
                        currentSessionId = null;
                        scrollChatToBottom();
                        return;
                    }
                    // otherwise fallthrough to normal chat start
                }

                // call chat start
                try{
                    const res = await fetch('/api/chat/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query: text, k:5})});
                    const data = await res.json();
                    if(data.error){ appendAssistantMessage('Error: '+data.error); return; }
                    currentSessionId = data.session_id;
                    if(data.friendly) appendAssistantMessage(data.friendly);
                    // show action prompt only if there are recipe results (avoid on pure greetings)
                    const total = (data.results && Array.isArray(data.results)) ? data.results.length : 0;
                    if(total > 0){
                        showActionPrompt(data.offset || 0, total);
                    }
                    scrollChatToBottom();
                }catch(err){ appendAssistantMessage('Error connecting to API: '+err); }
            }

            // --- Chat UI helpers ---
                        function appendUserMessage(text){
                            const chat = document.getElementById('chat');
                            const el = document.createElement('div');
                            el.className = 'message user';
                            const avatar = document.createElement('div');
                            avatar.className = 'avatar';
                            avatar.textContent = 'ğŸ‘¤';
                            const content = document.createElement('div');
                            content.className = 'msg-content';
                            const bubble = document.createElement('div');
                            bubble.className = 'bubble user-bubble';
                            bubble.innerHTML = escapeHtml(text);
                            const ts = document.createElement('div');
                            ts.className = 'timestamp';
                            ts.textContent = nowHM();
                            content.appendChild(bubble);
                            content.appendChild(ts);
                            el.appendChild(content);
                            el.appendChild(avatar);
                            chat.appendChild(el);
                        }

                        function appendAssistantMessage(text){
                            if(!text) return;
                            const bubble = document.createElement('div');
                            bubble.className = 'bubble assistant-bubble';
                            bubble.innerHTML = escapeHtml(text).replace(/\n/g,'<br/>');
                            appendAssistantNode(bubble);
                        }

                        function appendAssistantNode(node){
                            const chat = document.getElementById('chat');
                            const el = document.createElement('div');
                            el.className = 'message assistant';
                            const avatar = document.createElement('div');
                            avatar.className = 'avatar';
                            avatar.textContent = 'ğŸ³';
                            const content = document.createElement('div');
                            content.className = 'msg-content';
                            const ts = document.createElement('div');
                            ts.className = 'timestamp';
                            ts.textContent = nowHM();
                            content.appendChild(node);
                            content.appendChild(ts);
                            // order: content then avatar to keep avatar at far right
                            el.appendChild(avatar);
                            el.appendChild(content);
                            chat.appendChild(el);
                            return {wrapper: el, node};
                        }

            function appendResultsAsCards(items, session_id, baseIndex=0){
            const chat = document.getElementById('chat');
            const container = document.createElement('div');
            container.style.marginTop='6px';
            items.forEach((r, idx)=>{
                        const card = document.createElement('div');
                card.className='card';
                card.style.margin='8px 0';
                card.innerHTML = `
                            <div class="title">${escapeHtml(r.title)} <span class="meta">(${r.score.toFixed(3)})</span></div>
                            <div class="ingredients">${escapeHtml(r.ingredients || '')}</div>
                            <div style="margin-top:8px;display:flex;gap:8px;">
                                <button data-sid="${session_id}" data-idx="${baseIndex + idx}" class="view-btn">Ver detalles</button>
                                <button data-id="${r.id}" data-score="${r.score}" class="like-btn">ğŸ‘ Like</button>
                                <button data-id="${r.id}" data-score="${r.score}" class="dislike-btn">ğŸ‘ Dislike</button>
                                <button data-sid="${session_id}" data-base="${baseIndex}" class="more-btn">MÃ¡s</button>
                            </div>
                `;
                container.appendChild(card);
            });
            // wrap results inside an assistant message bubble area with avatar and timestamp
            appendAssistantNode(container);

            // attach listeners
                    container.querySelectorAll('.view-btn').forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                const sid = btn.getAttribute('data-sid');
                            const idx = parseInt(btn.getAttribute('data-idx'));
                            appendUserMessage('Mostrar detalles receta #' + (idx+1));
                scrollChatToBottom();
                        const resp = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id:sid, index:idx})});
                        const data = await resp.json();
                        if(data.error){ appendAssistantMessage('Error: '+data.error); }
                        else{
                            const txt = `Ingredientes:\n${data.ingredients || ''}\n`;
                            appendAssistantMessage(txt);

                            // After showing ingredients, present detail options (1 see / 2 back) and allow typed 1/2
                            const chat = document.getElementById('chat');
                                const b2 = document.createElement('div');
                                b2.className = 'bubble assistant-bubble';
                                b2.innerHTML = `
                                    <div>What would you like to do?</div>
                                    <div style="margin-top:8px; display:flex; gap:8px;">
                                        <button class="btn-see-inst">1ï¸ See instructions</button>
                                        <button class="btn-back-list">2ï¸ Back to recipe list</button>
                                    </div>
                                `;
                                appendAssistantNode(b2);

                            expectingDetailAction = true;
                            detailSelectedIdx = idx;

                            b2.querySelector('.btn-see-inst').addEventListener('click', async ()=>{
                                appendUserMessage('1');
                                expectingDetailAction = false;
                                const r = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: sid, index: idx})});
                                const d = await r.json();
                                if(d.error){ appendAssistantMessage('Error: '+d.error); }
                                else{
                                    const steps = String(d.instructions||'').split(/\n+|\r+|\.(?=\s|$)/).map(s=>s.trim()).filter(Boolean);
                                    let itxt = 'ğŸ‘¨â€ğŸ³ Instructions:\n\n';
                                    steps.forEach((s,i)=>{ itxt += `${i+1}. ${s}\n`; });
                                    appendAssistantMessage(itxt);
                                }
                                scrollChatToBottom();
                            });

                            b2.querySelector('.btn-back-list').addEventListener('click', ()=>{
                                appendUserMessage('2');
                                expectingDetailAction = false;
                                showActionPrompt(actionOffset, actionTotal);
                                scrollChatToBottom();
                            });
                        }
                scrollChatToBottom();
                });
            });

                    container.querySelectorAll('.like-btn, .dislike-btn').forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                const id = parseInt(btn.getAttribute('data-id'));
                const score = parseFloat(btn.getAttribute('data-score') || '0');
                const action = btn.classList.contains('like-btn') ? 'like' : 'dislike';
                // send feedback
                try{
                                await fetch('/api/feedback', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({user_id:null, query:lastQuery || '', recommended_ids:[id], scores:[score], feedback:action, method:'web-chat'})});
                                appendAssistantMessage(`Feedback ${action} registrado para id=${id}`);
                }catch(err){ appendAssistantMessage('Error sending feedback: '+err); }
                scrollChatToBottom();
                });
            });

                    container.querySelectorAll('.more-btn').forEach(btn=>{
                btn.addEventListener('click', async (e)=>{
                const sid = btn.getAttribute('data-sid');
                appendUserMessage('MÃ¡s recetas');
                scrollChatToBottom();
                            const resp = await fetch('/api/chat/more', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id:sid})});
                const data = await resp.json();
                if(data.error){ appendAssistantMessage('Error: '+data.error); }
                else{
                    if(data.text) appendAssistantMessage(data.text);
                                if(data.items && data.items.length) appendResultsAsCards(data.items, sid, data.offset);
                }
                scrollChatToBottom();
                });
            });
            }

            function scrollChatToBottom(){
            const chat = document.getElementById('chat');
            chat.scrollTop = chat.scrollHeight;
            }

                function showActionPrompt(currentOffset, totalCount){
                    // mark that assistant expects an action from the user (yes/no/more/exit or a number)
                    expectingAction = true;
                    actionOffset = currentOffset || 0;
                    actionTotal = totalCount || 0;
                    actionSessionId = currentSessionId;

                    const box = document.createElement('div');
                    box.className = 'bubble assistant-bubble';
                    box.innerHTML = `
                        <div>Did you like any recipe? (yes/no/more/exit)</div>
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn-yes">Yes</button>
                            <button class="btn-no">No</button>
                            <button class="btn-more">More</button>
                            <button class="btn-exit">Exit</button>
                        </div>
                    `;
                    appendAssistantNode(box);

                    // wire buttons
                    box.querySelector('.btn-yes').addEventListener('click', ()=>{
                        // user used a button; no longer require typed action
                        expectingAction = false;
                        appendUserMessage('yes');
                        // ask which number (1..3) for current page
                        const count = Math.min(3, Math.max(0, totalCount - currentOffset));
                        const b2 = document.createElement('div');
                        b2.className = 'bubble assistant-bubble';
                        b2.innerHTML = `
                            <div>Which number did you like?</div>
                            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                ${Array.from({length: count}, (_, i) => `<button class='btn-pick' data-index='${currentOffset + i}'>${i+1}</button>`).join('')}
                            </div>
                        `;
                        appendAssistantNode(b2);
                        b2.querySelectorAll('.btn-pick').forEach(btn=>{
                            btn.addEventListener('click', async ()=>{
                                const globalIdx = parseInt(btn.getAttribute('data-index'));
                                appendUserMessage(String(globalIdx+1));
                                expectingAction = false;
                                try{
                                    const resp = await fetch('/api/chat/recipe_ingredients', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: globalIdx, available: lastQuery})});
                                    const data = await resp.json();
                                    if(data.error){ appendAssistantMessage('Error: '+data.error); }
                                    else{
                                        let txt = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                                        txt += `ğŸ½ï¸ Recipe: ${data.title}\n`;
                                        txt += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
                                        txt += `Ingredients:\n\n`;
                                        for(const ing of data.ingredients){ txt += `â€¢ ${ing.text}\n`; }
                                        appendAssistantMessage(txt);

                                        // detail options
                                        const b3 = document.createElement('div');
                                        b3.className = 'bubble assistant-bubble';
                                        b3.innerHTML = `
                                            <div>What would you like to do?</div>
                                            <div style=\"margin-top:8px; display:flex; gap:8px;\">
                                                <button class=\"btn-see-inst\">1ï¸ See instructions</button>
                                                <button class=\"btn-back-list\">2ï¸ Back to recipe list</button>
                                            </div>
                                        `;
                                        appendAssistantNode(b3);

                                        expectingDetailAction = true;
                                        detailSelectedIdx = globalIdx;

                                        b3.querySelector('.btn-see-inst').addEventListener('click', async ()=>{
                                            appendUserMessage('1');
                                            expectingDetailAction = false;
                                            try{
                                                const r = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: globalIdx})});
                                                const d = await r.json();
                                                if(d.error){ appendAssistantMessage('Error: '+d.error); }
                                                else{
                                                    const steps = String(d.instructions||'').split(/\n+|\r+|\.(?=\s|$)/).map(s=>s.trim()).filter(Boolean);
                                                    let itxt = 'ğŸ‘¨â€ğŸ³ Instructions:\n\n';
                                                    steps.forEach((s,i)=>{ itxt += `${i+1}. ${s}\n`; });
                                                    appendAssistantMessage(itxt);
                                                }
                                            }catch(err){ appendAssistantMessage('Error: '+err); }
                                        });

                                        b3.querySelector('.btn-back-list').addEventListener('click', ()=>{
                                            appendUserMessage('2');
                                            expectingDetailAction = false;
                                            showActionPrompt(currentOffset, totalCount);
                                            scrollChatToBottom();
                                        });
                                    }
                                }catch(err){ appendAssistantMessage('Error: '+err); }
                                scrollChatToBottom();
                            });
                        });
                        scrollChatToBottom();
                        // attach pick handlers
                        b.querySelectorAll('.btn-pick').forEach(btn=>{
                            btn.addEventListener('click', async ()=>{
                                const globalIdx = parseInt(btn.getAttribute('data-index'));
                                appendUserMessage(String(globalIdx+1));
                                // fetch ingredients with availability marks
                                try{
                                    const resp = await fetch('/api/chat/recipe_ingredients', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: globalIdx, available: lastQuery})});
                                    const data = await resp.json();
                                    if(data.error){ appendAssistantMessage('Error: '+data.error); }
                                    else{
                                        let txt = `\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                                        txt += `ğŸ½ï¸ Recipe: ${data.title}\n`;
                                        txt += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
                                        txt += `Ingredients:\n\n`;
                                        for(const ing of data.ingredients){
                                            txt += `â€¢ ${ing.text}\n`;
                                        }
                                        appendAssistantMessage(txt);

                                        // options: see instructions or back to list
                                        const w2 = document.createElement('div');
                                        w2.className = 'message assistant';
                                        const b2 = document.createElement('div');
                                        b2.className = 'bubble assistant-bubble';
                                        b2.innerHTML = `
                                            <div>What would you like to do?</div>
                                            <div style="margin-top:8px; display:flex; gap:8px;">
                                                <button class="btn-see-inst">1ï¸ See instructions</button>
                                                <button class="btn-back-list">2ï¸ Back to recipe list</button>
                                            </div>
                                        `;
                                        w2.appendChild(b2);
                                        chat.appendChild(w2);

                                        b2.querySelector('.btn-see-inst').addEventListener('click', async ()=>{
                                            appendUserMessage('1');
                                            const r = await fetch('/api/chat/select', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId, index: globalIdx})});
                                            const d = await r.json();
                                            if(d.error){ appendAssistantMessage('Error: '+d.error); }
                                            else{
                                                // simple step split
                                                const steps = String(d.instructions||'').split(/\n+|\r+|\.(?=\s|$)/).map(s=>s.trim()).filter(Boolean);
                                                let itxt = 'ğŸ‘¨â€ğŸ³ Instructions:\n\n';
                                                steps.forEach((s,i)=>{ itxt += `${i+1}. ${s}\n`; });
                                                appendAssistantMessage(itxt);
                                            }
                                            scrollChatToBottom();
                                        });

                                        b2.querySelector('.btn-back-list').addEventListener('click', ()=>{
                                            appendUserMessage('2');
                                            // re-show prompt for actions
                                            showActionPrompt(currentOffset, totalCount);
                                            scrollChatToBottom();
                                        });
                                    }
                                }catch(err){ appendAssistantMessage('Error: '+err); }
                                scrollChatToBottom();
                            });
                        });
                        scrollChatToBottom();
                    });

                    box.querySelector('.btn-no').addEventListener('click', ()=>{
                        expectingAction = false;
                        appendUserMessage('no');
                        appendAssistantMessage("I'll keep improving!");
                        scrollChatToBottom();
                    });

                    box.querySelector('.btn-more').addEventListener('click', async ()=>{
                        expectingAction = false;
                        appendUserMessage('more');
                        try{
                            const resp = await fetch('/api/chat/more', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({session_id: currentSessionId})});
                            const data = await resp.json();
                            if(data.error){ appendAssistantMessage('Error: '+data.error); }
                            else{
                                if(data.text) appendAssistantMessage(data.text);
                                // show prompt again referencing new offset
                                showActionPrompt(data.offset, totalCount);
                            }
                        }catch(err){ appendAssistantMessage('Error: '+err); }
                        scrollChatToBottom();
                    });

                    box.querySelector('.btn-exit').addEventListener('click', ()=>{
                        expectingAction = false;
                        appendUserMessage('exit');
                        appendAssistantMessage('Goodbye ğŸ‘‹');
                        currentSessionId = null;
                        scrollChatToBottom();
                    });
                }
        </script>
    </body>
</html>